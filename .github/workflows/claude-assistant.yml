name: Claude Assistant

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  claude-respond:
    # Only run if comment mentions @claude
    if: contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@Claude')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Install GitHub CLI
        run: |
          type gh || brew install gh || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
          sudo apt update && \
          sudo apt install gh -y)

      - name: Configure Git
        run: |
          git config user.name "Claude Assistant"
          git config user.email "claude-assistant@anthropic.com"

      - name: Run Claude Assistant
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REPO_NAME: ${{ github.repository }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          node << 'SCRIPT_EOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');

          // Helper functions
          function exec(command) {
            try {
              return execSync(command, { encoding: 'utf-8', stdio: 'pipe' });
            } catch (error) {
              return `Error: ${error.message}\nStderr: ${error.stderr}`;
            }
          }

          function readFile(filePath) {
            try {
              return fs.readFileSync(filePath, 'utf-8');
            } catch (error) {
              return `Error reading file: ${error.message}`;
            }
          }

          function writeFile(filePath, content) {
            try {
              fs.writeFileSync(filePath, content, 'utf-8');
              return `File written successfully: ${filePath}`;
            } catch (error) {
              return `Error writing file: ${error.message}`;
            }
          }

          function editFile(filePath, oldString, newString) {
            try {
              const content = fs.readFileSync(filePath, 'utf-8');
              if (!content.includes(oldString)) {
                return `Error: oldString not found in file`;
              }
              const newContent = content.replace(oldString, newString);
              fs.writeFileSync(filePath, newContent, 'utf-8');
              return `File edited successfully: ${filePath}`;
            } catch (error) {
              return `Error editing file: ${error.message}`;
            }
          }

          function postComment(message) {
            const payload = JSON.stringify({ body: message });
            const curl = `curl -X POST -H "Authorization: token ${process.env.GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${process.env.REPO_NAME}/issues/${process.env.ISSUE_NUMBER}/comments -d '${payload.replace(/'/g, "'\\''")}'`;
            exec(curl);
          }

          // Tool definitions for Claude
          const tools = [
            {
              name: "read_file",
              description: "Read the contents of a file in the repository",
              input_schema: {
                type: "object",
                properties: {
                  file_path: {
                    type: "string",
                    description: "Path to the file relative to repository root"
                  }
                },
                required: ["file_path"]
              }
            },
            {
              name: "write_file",
              description: "Write content to a file (creates or overwrites)",
              input_schema: {
                type: "object",
                properties: {
                  file_path: {
                    type: "string",
                    description: "Path to the file relative to repository root"
                  },
                  content: {
                    type: "string",
                    description: "Content to write to the file"
                  }
                },
                required: ["file_path", "content"]
              }
            },
            {
              name: "edit_file",
              description: "Edit a file by replacing old string with new string",
              input_schema: {
                type: "object",
                properties: {
                  file_path: {
                    type: "string",
                    description: "Path to the file relative to repository root"
                  },
                  old_string: {
                    type: "string",
                    description: "String to find and replace"
                  },
                  new_string: {
                    type: "string",
                    description: "String to replace with"
                  }
                },
                required: ["file_path", "old_string", "new_string"]
              }
            },
            {
              name: "run_command",
              description: "Run a shell command (git commands, ls, etc.)",
              input_schema: {
                type: "object",
                properties: {
                  command: {
                    type: "string",
                    description: "Shell command to execute"
                  }
                },
                required: ["command"]
              }
            }
          ];

          // Process tool calls
          function processTool(toolName, toolInput) {
            console.log(`\n========================================`);
            console.log(`EXECUTING TOOL: ${toolName}`);
            console.log(`Input:`, JSON.stringify(toolInput, null, 2));
            console.log(`========================================\n`);

            let result;
            switch(toolName) {
              case 'read_file':
                result = readFile(toolInput.file_path);
                break;
              case 'write_file':
                result = writeFile(toolInput.file_path, toolInput.content);
                break;
              case 'edit_file':
                result = editFile(toolInput.file_path, toolInput.old_string, toolInput.new_string);
                break;
              case 'run_command':
                result = exec(toolInput.command);
                break;
              default:
                result = `ERROR: Unknown tool: ${toolName}`;
            }

            console.log(`\nTool result preview:`, result.substring(0, 200));
            return result;
          }

          async function main() {
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            const issueNumber = process.env.ISSUE_NUMBER;
            const issueTitle = process.env.ISSUE_TITLE;
            const issueBody = process.env.ISSUE_BODY;
            const commentBody = process.env.COMMENT_BODY;

            console.log('Starting Claude Assistant...');

            const systemPrompt = `You are Claude, an AI assistant integrated with GitHub Actions with TOOL USE capabilities. You MUST use the provided tools to read files, edit files, and run commands.

CRITICAL: You have access to actual tools via the Anthropic tool use API. Do NOT generate pseudo-code or XML tags. Use the real tools provided.

Repository: ${process.env.REPO_NAME}
Current branch: main (you're in the repository root directory)

AVAILABLE TOOLS (use these via tool calls, NOT pseudo-code):

1. read_file - Read a file's contents
   Parameters: { "file_path": "path/to/file" }
   Use this to understand the current code before making changes.

2. edit_file - Replace a string in a file
   Parameters: { "file_path": "path/to/file", "old_string": "exact text to replace", "new_string": "replacement text" }
   Use this to make precise edits. The old_string must match exactly.

3. write_file - Create or completely overwrite a file
   Parameters: { "file_path": "path/to/file", "content": "entire file content" }
   Use this cautiously - it overwrites the entire file.

4. run_command - Execute a shell command
   Parameters: { "command": "shell command" }
   Use this for git operations, creating branches, pushing, etc.

IMPORTANT WORKFLOW:
1. Start by reading index.html using read_file
2. Create a feature branch: run_command with "git checkout -b feature/issue-${issueNumber}-short-name"
3. Make code changes using edit_file (preferred) or write_file
4. Commit: run_command with "git add index.html && git commit -m 'description'"
5. Push: run_command with "git push -u origin BRANCH_NAME"
6. Create PR: run_command with "gh pr create --title '...' --body 'Closes #${issueNumber}'"
7. After all tools complete, provide a final summary

RULES:
- ALWAYS use run_command for git operations, NEVER generate bash pseudo-code
- Use edit_file for surgical changes, write_file only if rewriting entire file
- Create descriptive commit messages
- Test your implementation logic before committing
- Provide a clear summary at the end

You are running in GitHub Actions with full git and gh CLI access.`;

            const userPrompt = `A user has requested help with the following issue:

Issue #${issueNumber}: ${issueTitle}

Description:
${issueBody}

User Comment:
${commentBody}

TASK: Implement this feature or fix this bug using your tools.

STEP-BY-STEP INSTRUCTIONS (follow exactly):

1. Use read_file tool to read "index.html"
2. Use run_command tool: "git checkout -b feature/issue-${issueNumber}-priority-levels"
3. Use edit_file tool to make the necessary code changes
   (make multiple edit_file calls if needed for different sections)
4. Use run_command tool: "git add index.html"
5. Use run_command tool: "git commit -m 'Add feature for issue #${issueNumber}\\n\\nCloses #${issueNumber}'"
6. Use run_command tool: "git push -u origin BRANCH_NAME"
7. Use run_command tool: "gh pr create --title 'TITLE' --body 'Closes #${issueNumber}'"
8. Provide a final text summary of what you implemented

IMPORTANT:
- Use the actual tools (read_file, edit_file, run_command)
- Do NOT write pseudo-code or XML tags
- Each step above should be a real tool call
- After pushing and creating PR, stop and provide summary

Begin by using the read_file tool to read index.html.`;

            const messages = [{ role: 'user', content: userPrompt }];
            let continueLoop = true;
            let iterationCount = 0;
            const maxIterations = 25;

            // Post initial comment to let user know we're working
            postComment('ü§ñ Claude Assistant is working on this issue...\n\nI\'ll implement the requested changes and create a pull request. This may take 2-3 minutes.');

            while (continueLoop && iterationCount < maxIterations) {
              iterationCount++;
              console.log(`\n${'='.repeat(60)}`);
              console.log(`ITERATION ${iterationCount}/${maxIterations}`);
              console.log('='.repeat(60));

              const response = await anthropic.messages.create({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 8000,
                system: systemPrompt,
                tools: tools,
                messages: messages
              });

              console.log('Response stop_reason:', response.stop_reason);

              // Add assistant response to messages
              messages.push({ role: 'assistant', content: response.content });

              // Check if we need to process tool calls
              if (response.stop_reason === 'tool_use') {
                const toolResults = [];

                for (const content of response.content) {
                  if (content.type === 'tool_use') {
                    const result = processTool(content.name, content.input);
                    toolResults.push({
                      type: 'tool_result',
                      tool_use_id: content.id,
                      content: result
                    });
                  }
                }

                // Add tool results to messages
                messages.push({ role: 'user', content: toolResults });
              } else {
                // No more tool calls, we're done
                continueLoop = false;

                // Extract final text response
                let finalResponse = '';
                for (const content of response.content) {
                  if (content.type === 'text') {
                    finalResponse += content.text;
                  }
                }

                console.log('Final response:', finalResponse);

                // Post final comment to GitHub
                const fullComment = finalResponse + '\n\n---\nü§ñ *Automated implementation by Claude via GitHub Actions*';
                postComment(fullComment);
              }
            }

            if (iterationCount >= maxIterations) {
              console.log('Max iterations reached');
              postComment('‚ö†Ô∏è Implementation exceeded maximum iterations. Please check the workflow logs.');
            }

            console.log('Claude Assistant completed');
          }

          main().catch(error => {
            console.error('Error:', error);
            const payload = JSON.stringify({
              body: `‚ùå Error running Claude Assistant: ${error.message}\n\nPlease check the workflow logs for details.`
            });
            const curl = `curl -X POST -H "Authorization: token ${process.env.GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${process.env.REPO_NAME}/issues/${process.env.ISSUE_NUMBER}/comments -d '${payload.replace(/'/g, "'\\''")}'`;
            require('child_process').execSync(curl);
            process.exit(1);
          });
          SCRIPT_EOF
