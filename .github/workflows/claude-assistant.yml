name: Claude Assistant

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  claude-respond:
    # Only run if comment mentions @claude
    if: contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@Claude')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Configure Git
        run: |
          git config user.name "Claude Assistant"
          git config user.email "claude-assistant@anthropic.com"

      - name: Run Claude Assistant
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REPO_NAME: ${{ github.repository }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          node << 'SCRIPT_EOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');

          // Helper functions
          function exec(command) {
            try {
              return execSync(command, { encoding: 'utf-8', stdio: 'pipe' });
            } catch (error) {
              return `Error: ${error.message}\nStderr: ${error.stderr}`;
            }
          }

          function readFile(filePath) {
            try {
              return fs.readFileSync(filePath, 'utf-8');
            } catch (error) {
              return `Error reading file: ${error.message}`;
            }
          }

          function writeFile(filePath, content) {
            try {
              fs.writeFileSync(filePath, content, 'utf-8');
              return `File written successfully: ${filePath}`;
            } catch (error) {
              return `Error writing file: ${error.message}`;
            }
          }

          function editFile(filePath, oldString, newString) {
            try {
              const content = fs.readFileSync(filePath, 'utf-8');
              if (!content.includes(oldString)) {
                return `Error: oldString not found in file`;
              }
              const newContent = content.replace(oldString, newString);
              fs.writeFileSync(filePath, newContent, 'utf-8');
              return `File edited successfully: ${filePath}`;
            } catch (error) {
              return `Error editing file: ${error.message}`;
            }
          }

          function postComment(message) {
            const payload = JSON.stringify({ body: message });
            const curl = `curl -X POST -H "Authorization: token ${process.env.GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${process.env.REPO_NAME}/issues/${process.env.ISSUE_NUMBER}/comments -d '${payload.replace(/'/g, "'\\''")}'`;
            exec(curl);
          }

          // Tool definitions for Claude
          const tools = [
            {
              name: "read_file",
              description: "Read the contents of a file in the repository",
              input_schema: {
                type: "object",
                properties: {
                  file_path: {
                    type: "string",
                    description: "Path to the file relative to repository root"
                  }
                },
                required: ["file_path"]
              }
            },
            {
              name: "write_file",
              description: "Write content to a file (creates or overwrites)",
              input_schema: {
                type: "object",
                properties: {
                  file_path: {
                    type: "string",
                    description: "Path to the file relative to repository root"
                  },
                  content: {
                    type: "string",
                    description: "Content to write to the file"
                  }
                },
                required: ["file_path", "content"]
              }
            },
            {
              name: "edit_file",
              description: "Edit a file by replacing old string with new string",
              input_schema: {
                type: "object",
                properties: {
                  file_path: {
                    type: "string",
                    description: "Path to the file relative to repository root"
                  },
                  old_string: {
                    type: "string",
                    description: "String to find and replace"
                  },
                  new_string: {
                    type: "string",
                    description: "String to replace with"
                  }
                },
                required: ["file_path", "old_string", "new_string"]
              }
            },
            {
              name: "run_command",
              description: "Run a shell command (git commands, ls, etc.)",
              input_schema: {
                type: "object",
                properties: {
                  command: {
                    type: "string",
                    description: "Shell command to execute"
                  }
                },
                required: ["command"]
              }
            }
          ];

          // Process tool calls
          function processTool(toolName, toolInput) {
            console.log(`Executing tool: ${toolName}`, toolInput);

            switch(toolName) {
              case 'read_file':
                return readFile(toolInput.file_path);
              case 'write_file':
                return writeFile(toolInput.file_path, toolInput.content);
              case 'edit_file':
                return editFile(toolInput.file_path, toolInput.old_string, toolInput.new_string);
              case 'run_command':
                return exec(toolInput.command);
              default:
                return `Unknown tool: ${toolName}`;
            }
          }

          async function main() {
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            const issueNumber = process.env.ISSUE_NUMBER;
            const issueTitle = process.env.ISSUE_TITLE;
            const issueBody = process.env.ISSUE_BODY;
            const commentBody = process.env.COMMENT_BODY;

            console.log('Starting Claude Assistant...');

            const systemPrompt = `You are Claude, an AI assistant integrated with GitHub Actions. You can read files, edit files, and run commands to implement features and fix bugs.

Repository: ${process.env.REPO_NAME}
Current branch: main

You have access to these tools:
- read_file: Read file contents
- write_file: Create or overwrite files
- edit_file: Replace strings in files
- run_command: Execute shell commands (git, ls, etc.)

Your workflow:
1. Read relevant files to understand the codebase
2. Implement the requested changes
3. Create a feature branch (use format: feature/issue-${issueNumber}-short-name)
4. Commit your changes with a descriptive message
5. Push the branch
6. Create a pull request using gh CLI
7. Summarize what you did

Be thorough and implement complete, working solutions. Always create a branch, never commit directly to main.`;

            const userPrompt = `Issue #${issueNumber}: ${issueTitle}

Issue Description:
${issueBody}

User Request:
${commentBody}

Please implement this feature or fix. Follow the workflow:
1. Read index.html to understand current structure
2. Create a feature branch
3. Make necessary code changes
4. Test mentally to ensure it works
5. Commit with a good message
6. Push the branch
7. Create a PR using: gh pr create --title "..." --body "Closes #${issueNumber}"
8. Provide a summary

Start by reading the main file.`;

            const messages = [{ role: 'user', content: userPrompt }];
            let continueLoop = true;
            let iterationCount = 0;
            const maxIterations = 25;

            while (continueLoop && iterationCount < maxIterations) {
              iterationCount++;
              console.log(`\nIteration ${iterationCount}...`);

              const response = await anthropic.messages.create({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 8000,
                system: systemPrompt,
                tools: tools,
                messages: messages
              });

              console.log('Response stop_reason:', response.stop_reason);

              // Add assistant response to messages
              messages.push({ role: 'assistant', content: response.content });

              // Check if we need to process tool calls
              if (response.stop_reason === 'tool_use') {
                const toolResults = [];

                for (const content of response.content) {
                  if (content.type === 'tool_use') {
                    const result = processTool(content.name, content.input);
                    toolResults.push({
                      type: 'tool_result',
                      tool_use_id: content.id,
                      content: result
                    });
                  }
                }

                // Add tool results to messages
                messages.push({ role: 'user', content: toolResults });
              } else {
                // No more tool calls, we're done
                continueLoop = false;

                // Extract final text response
                let finalResponse = '';
                for (const content of response.content) {
                  if (content.type === 'text') {
                    finalResponse += content.text;
                  }
                }

                console.log('Final response:', finalResponse);

                // Post final comment to GitHub
                const fullComment = finalResponse + '\n\n---\nü§ñ *Automated implementation by Claude via GitHub Actions*';
                postComment(fullComment);
              }
            }

            if (iterationCount >= maxIterations) {
              console.log('Max iterations reached');
              postComment('‚ö†Ô∏è Implementation exceeded maximum iterations. Please check the workflow logs.');
            }

            console.log('Claude Assistant completed');
          }

          main().catch(error => {
            console.error('Error:', error);
            const payload = JSON.stringify({
              body: `‚ùå Error running Claude Assistant: ${error.message}\n\nPlease check the workflow logs for details.`
            });
            const curl = `curl -X POST -H "Authorization: token ${process.env.GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${process.env.REPO_NAME}/issues/${process.env.ISSUE_NUMBER}/comments -d '${payload.replace(/'/g, "'\\''")}'`;
            require('child_process').execSync(curl);
            process.exit(1);
          });
          SCRIPT_EOF
